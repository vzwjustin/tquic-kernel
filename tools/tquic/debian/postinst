#!/bin/bash
set -e

case "$1" in
    configure)
        # Create directories
        mkdir -p /etc/tquic.d
        mkdir -p /var/log/tquic
        mkdir -p /run/tquicd

        # Set kernel parameters for high-performance networking
        cat > /etc/sysctl.d/90-tquic.conf << 'EOF'
# TQUIC VPS tuning
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.tcp_fastopen = 3
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 86400
# Required for TPROXY
net.ipv4.ip_forward = 1
net.ipv4.conf.all.route_localnet = 1
EOF
        sysctl -p /etc/sysctl.d/90-tquic.conf 2>/dev/null || true

        # Enable GRO/GSO on primary interface
        PRIMARY_IF=$(ip route get 8.8.8.8 2>/dev/null | grep -oP 'dev \K\S+' || true)
        if [ -n "$PRIMARY_IF" ]; then
            ethtool -K "$PRIMARY_IF" gro on gso on 2>/dev/null || true
        fi

        # Setup nftables masquerade and TPROXY
        if command -v nft >/dev/null 2>&1; then
            # NAT table for masquerade
            nft add table inet tquic 2>/dev/null || true
            nft add chain inet tquic postrouting '{ type nat hook postrouting priority srcnat ; }' 2>/dev/null || true
            nft add rule inet tquic postrouting oifname "$PRIMARY_IF" masquerade 2>/dev/null || true

            # TPROXY table for transparent proxying
            # Create mangle chain for TPROXY
            nft add table ip tquic_tproxy 2>/dev/null || true
            nft add chain ip tquic_tproxy prerouting '{ type filter hook prerouting priority mangle ; }' 2>/dev/null || true

            # Mark packets for local routing (required for TPROXY)
            # These rules are templates - actual ports configured via /etc/tquic.d/*.conf
            # Example: redirect port 80/443 to local tquicd
            # nft add rule ip tquic_tproxy prerouting tcp dport { 80, 443 } tproxy to :8443 meta mark set 1

            # Add routing rule for marked packets
            ip rule add fwmark 1 lookup 100 2>/dev/null || true
            ip route add local 0.0.0.0/0 dev lo table 100 2>/dev/null || true

            echo "TPROXY nftables tables created. Configure ports in /etc/tquic.d/*.conf"
        fi

        # Enable and start service
        systemctl daemon-reload
        deb-systemd-invoke enable tquicd.service || true
        deb-systemd-invoke start tquicd.service || true
        ;;
esac

#DEBHELPER#
