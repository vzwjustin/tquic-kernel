# SPDX-License-Identifier: GPL-2.0-only
#
# Build full bootable Linux kernel packages with TQUIC integrated.
#
name: Kernel Package Build

on:
  workflow_dispatch:
    inputs:
      kernel_full:
        description: "Kernel version to build (example: 6.19-rc8, 6.12.69)"
        required: true
        default: "6.19-rc8"
      kernel_major:
        description: "Kernel major series for stable releases (example: 6)"
        required: true
        default: "6"
      kernel_testing:
        description: "Use kernel.org testing tree (true for rc kernels)"
        required: true
        default: "true"
      artifact_name:
        description: "Artifact bundle name"
        required: true
        default: "tquic-kernel-debs"
      upload_to_release:
        description: "Upload to GitHub release (specify tag name, or leave empty to skip)"
        required: false
        default: ""
  push:
    tags:
      - 'v*'
      - 'Experimental*'

jobs:
  build-kernel:
    name: "Build kernel ${{ inputs.kernel_full || '6.19-rc8' }}"
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Set build parameters
        id: params
        run: |
          # Use inputs if workflow_dispatch, otherwise use defaults for tag push
          KVER="${{ inputs.kernel_full || '6.19-rc8' }}"
          MAJOR="${{ inputs.kernel_major || '6' }}"
          TESTING="${{ inputs.kernel_testing || 'true' }}"
          ARTIFACT="${{ inputs.artifact_name || 'tquic-kernel-debs' }}"

          echo "kernel_full=${KVER}" >> $GITHUB_OUTPUT
          echo "kernel_major=${MAJOR}" >> $GITHUB_OUTPUT
          echo "kernel_testing=${TESTING}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT}" >> $GITHUB_OUTPUT

          echo "Building kernel ${KVER} (major: ${MAJOR}, testing: ${TESTING})"

      - name: Checkout TQUIC source
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: >-
            ccache-${{ runner.os }}-${{ steps.params.outputs.kernel_full }}-${{
              hashFiles(
                '.github/workflows/kernel-package.yml',
                'net/quic/**',
                'net/tquic/**',
                'include/net/**',
                'include/uapi/**'
              )
            }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ steps.params.outputs.kernel_full }}-

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            bc bison build-essential cpio debhelper-compat \
            ccache \
            dwarves fakeroot flex kmod libdw-dev libelf-dev libssl-dev \
            pahole rsync xz-utils zstd

      - name: Download upstream kernel source
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-src && cd ~/kernel-src
          KVER="${{ steps.params.outputs.kernel_full }}"
          MAJOR="${{ steps.params.outputs.kernel_major }}"

          if [ "${{ steps.params.outputs.kernel_testing }}" = "true" ]; then
            URL="https://git.kernel.org/torvalds/t/linux-${KVER}.tar.gz"
            ARCHIVE="linux-${KVER}.tar.gz"
          else
            URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${KVER}.tar.xz"
            ARCHIVE="linux-${KVER}.tar.xz"
          fi

          echo "Downloading ${URL}"
          curl -fSL --retry 3 --retry-delay 5 -o "${ARCHIVE}" "${URL}"
          tar xf "${ARCHIVE}"
          rm -f "${ARCHIVE}"

      - name: Overlay TQUIC integration paths onto upstream kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          SRC="${GITHUB_WORKSPACE}"

          # Overlay only TQUIC-related paths so the result is a standard
          # upstream kernel plus TQUIC integration.
          for p in \
            "net/tquic/" \
            "net/quic/" \
            "net/Kconfig" \
            "net/Makefile" \
            "include/net/netns/tquic.h" \
            "include/net/net_namespace.h" \
            "include/net/tquic/" \
            "include/net/quic/" \
            "include/net/tquic.h" \
            "include/net/tquic_frame.h" \
            "include/net/tquic_http3.h" \
            "include/net/tquic_pm.h" \
            "include/net/tquic_pmtud.h" \
            "include/uapi/linux/tquic.h" \
            "include/uapi/linux/tquic_pm.h" \
            "include/uapi/linux/tquic_diag.h" \
            "include/uapi/linux/tquic_qlog.h" \
            "include/crypto/"; do
            if [ -e "${SRC}/${p}" ]; then
              if [ -d "${SRC}/${p}" ]; then
                mkdir -p "${KDIR}/${p}"
                rsync -a --delete "${SRC}/${p}" "${KDIR}/${p}"
              else
                mkdir -p "$(dirname "${KDIR}/${p}")"
                install -m 0644 "${SRC}/${p}" "${KDIR}/${p}"
              fi
            fi
          done

      - name: Configure kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          make defconfig

          # Keep CI resilient across toolchain/kernel warning changes.
          # (Werror can be enabled indirectly via COMPILE_TEST.)
          scripts/config --disable CONFIG_WERROR

          # Ensure module and TQUIC support are enabled in packaged kernel.
          # CRITICAL: Enable CONFIG_IP_QUIC first - this is the main option
          # that gates all CONFIG_TQUIC_* sub-options in net/tquic/Kconfig
          scripts/config --enable CONFIG_MODULES
          scripts/config --enable CONFIG_IP_QUIC

          # Enable TQUIC sub-features (only available after CONFIG_IP_QUIC=y)
          scripts/config --enable CONFIG_TQUIC_CORE
          scripts/config --enable CONFIG_TQUIC_WAN_BONDING
          scripts/config --enable CONFIG_TQUIC_MULTIPATH
          scripts/config --enable CONFIG_TQUIC_PATH_MANAGER
          scripts/config --enable CONFIG_TQUIC_PM_NETLINK
          scripts/config --enable CONFIG_TQUIC_SCHEDULER
          scripts/config --enable CONFIG_TQUIC_CONG
          scripts/config --enable CONFIG_TQUIC_CRYPTO
          scripts/config --enable CONFIG_TQUIC_CERT_VERIFY
          scripts/config --enable CONFIG_TQUIC_IPV6

          # Apply dependencies and finalize config
          make olddefconfig

      - name: Smoke build TQUIC (fast)
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          # Ensure generated headers + scripts exist, then compile only the
          # TQUIC-related parts. This catches real compiler errors quickly
          # without spending time on a full kernel build.
          make -j"$(nproc)" prepare scripts
          make -j"$(nproc)" net/quic/ net/tquic/

      - name: Build Debian kernel packages
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          export PATH="/usr/lib/ccache:${PATH}"
          ccache -M 5G || true

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-8)"
          LOCALVER="-tquic-${SHORT_SHA}"
          PKGVER="1.${GITHUB_RUN_NUMBER}"

          # Build image + headers + modules packages.
          make -j"$(nproc)" \
            LOCALVERSION="${LOCALVER}" \
            KDEB_PKGVERSION="${PKGVER}" \
            bindeb-pkg

      - name: Collect package artifacts
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-artifacts
          find ~/kernel-src -maxdepth 2 -type f \
            \( -name "*.deb" -o -name "*.changes" -o -name "*.buildinfo" \) \
            -exec cp -v {} ~/kernel-artifacts/ \;
          cd ~/kernel-artifacts
          sha256sum * > SHA256SUMS.txt
          ls -lah

      - name: Upload kernel packages
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.params.outputs.artifact_name }}-${{ steps.params.outputs.kernel_full }}
          path: ~/kernel-artifacts/*
          if-no-files-found: error
          retention-days: 14

      - name: Determine release tag
        id: release_tag
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ -n "${{ github.ref_name }}" ]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Auto-detected tag from push: ${{ github.ref_name }}"
          elif [ -n "${{ inputs.upload_to_release }}" ]; then
            echo "tag=${{ inputs.upload_to_release }}" >> $GITHUB_OUTPUT
            echo "Using manual tag: ${{ inputs.upload_to_release }}"
          else
            echo "tag=" >> $GITHUB_OUTPUT
            echo "No release tag specified, skipping upload"
          fi

      - name: Upload to GitHub Release
        if: steps.release_tag.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          files: ~/kernel-artifacts/*
          prerelease: true
          fail_on_unmatched_files: false
          body: |
            ## TQUIC Kernel ${{ steps.params.outputs.kernel_full }}

            Kernel image and headers with TQUIC/multipath QUIC integrated.

            **Built from**: ${{ github.sha }}
            **Build date**: ${{ github.run_id }}

            ### Installation
            ```bash
            sudo dpkg -i linux-image-*.deb linux-headers-*.deb
            sudo reboot
            ```

            ### Verify
            ```bash
            uname -r  # Should show -tquic- in version
            modinfo tquic  # Check TQUIC module
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
