# SPDX-License-Identifier: GPL-2.0-only
#
# Build full bootable Linux kernel packages with TQUIC integrated.
#
name: Kernel Package Build

on:
  workflow_dispatch:
    inputs:
      kernel_full:
        description: "Kernel version to build (example: 6.19, 6.12.69)"
        required: true
        default: "6.19"
      kernel_major:
        description: "Kernel major series for stable releases (example: 6)"
        required: true
        default: "6"
      kernel_testing:
        description: "Use kernel.org testing tree (true for rc kernels)"
        required: true
        default: "false"
      artifact_name:
        description: "Artifact bundle name"
        required: true
        default: "tquic-kernel-debs"
      upload_to_release:
        description: "Upload to GitHub release (specify tag name, or leave empty to skip)"
        required: false
        default: ""
  push:
    tags:
      - 'v*'
      - 'Experimental*'
    branches:
      - 'claude/**'
  pull_request:
    branches:
      - main

jobs:
  # Fast smoke build for branches/PRs — catches compilation and MODPOST errors
  smoke-build:
    name: "Smoke build TQUIC"
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Set build parameters
        id: params
        run: |
          KVER="${{ inputs.kernel_full || '6.19' }}"
          MAJOR="${{ inputs.kernel_major || '6' }}"
          TESTING="${{ inputs.kernel_testing || 'false' }}"
          echo "kernel_full=${KVER}" >> $GITHUB_OUTPUT
          echo "kernel_major=${MAJOR}" >> $GITHUB_OUTPUT
          echo "kernel_testing=${TESTING}" >> $GITHUB_OUTPUT

      - name: Checkout TQUIC source
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: >-
            ccache-smoke-${{ runner.os }}-${{ steps.params.outputs.kernel_full }}-${{
              hashFiles(
                '.github/workflows/kernel-package.yml',
                'net/quic/**',
                'net/tquic/**',
                'include/net/**',
                'include/uapi/**'
              )
            }}
          restore-keys: |
            ccache-smoke-${{ runner.os }}-${{ steps.params.outputs.kernel_full }}-

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            bc bison build-essential cpio \
            ccache \
            dwarves fakeroot flex kmod libdw-dev libelf-dev libssl-dev \
            pahole rsync xz-utils zstd

      - name: Download upstream kernel source
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-src && cd ~/kernel-src
          KVER="${{ steps.params.outputs.kernel_full }}"
          MAJOR="${{ steps.params.outputs.kernel_major }}"

          if [ "${{ steps.params.outputs.kernel_testing }}" = "true" ]; then
            URL="https://git.kernel.org/torvalds/t/linux-${KVER}.tar.gz"
            ARCHIVE="linux-${KVER}.tar.gz"
          else
            URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${KVER}.tar.xz"
            ARCHIVE="linux-${KVER}.tar.xz"
          fi

          echo "Downloading: ${URL}"
          curl -fSL \
            --connect-timeout 30 \
            --max-time 600 \
            --retry 5 \
            --retry-delay 10 \
            --retry-max-time 300 \
            -o "${ARCHIVE}" "${URL}"
          tar xf "${ARCHIVE}"
          rm -f "${ARCHIVE}"

      - name: Overlay TQUIC integration paths onto upstream kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          SRC="${GITHUB_WORKSPACE}"

          for p in \
            "net/tquic/" \
            "net/quic/" \
            "net/Kconfig" \
            "net/Makefile" \
            "include/net/netns/tquic.h" \
            "include/net/net_namespace.h" \
            "include/net/tquic/" \
            "include/net/quic/" \
            "include/net/tquic.h" \
            "include/net/tquic_frame.h" \
            "include/net/tquic_http3.h" \
            "include/net/tquic_pm.h" \
            "include/net/tquic_pmtud.h" \
            "include/uapi/linux/tquic.h" \
            "include/uapi/linux/tquic_pm.h" \
            "include/uapi/linux/tquic_diag.h" \
            "include/uapi/linux/tquic_qlog.h"; do
            if [ -e "${SRC}/${p}" ]; then
              if [ -d "${SRC}/${p}" ]; then
                mkdir -p "${KDIR}/${p}"
                rsync -a --delete "${SRC}/${p}" "${KDIR}/${p}"
              else
                mkdir -p "$(dirname "${KDIR}/${p}")"
                install -m 0644 "${SRC}/${p}" "${KDIR}/${p}"
              fi
            fi
          done

      - name: Configure kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          make defconfig
          scripts/config --disable CONFIG_WERROR
          scripts/config --enable CONFIG_MODULES
          scripts/config --module CONFIG_IP_QUIC
          scripts/config --module CONFIG_TQUIC_CORE
          scripts/config --module CONFIG_TQUIC_WAN_BONDING
          scripts/config --module CONFIG_TQUIC_MULTIPATH
          scripts/config --module CONFIG_TQUIC_PATH_MANAGER
          scripts/config --module CONFIG_TQUIC_PM_NETLINK
          scripts/config --module CONFIG_TQUIC_SCHEDULER
          scripts/config --module CONFIG_TQUIC_CONG
          scripts/config --module CONFIG_TQUIC_CRYPTO
          scripts/config --module CONFIG_TQUIC_CERT_VERIFY
          scripts/config --module CONFIG_TQUIC_IPV6
          scripts/config --module CONFIG_INET_DIAG
          scripts/config --module CONFIG_CRYPTO_CURVE25519
          scripts/config --enable CONFIG_TRACEPOINTS

          # USB network drivers for phone tethering and USB ethernet adapters
          scripts/config --enable CONFIG_MII                  # MII library (required by USB_USBNET)
          scripts/config --module CONFIG_USB_USBNET           # USB networking framework (required base)
          scripts/config --enable CONFIG_USB_NET_DRIVERS
          scripts/config --module CONFIG_USB_IPHETH           # Apple iPhone USB tethering
          scripts/config --module CONFIG_USB_NET_RNDIS_HOST   # Android/Windows phone tethering
          scripts/config --module CONFIG_USB_NET_CDC_ETHER    # Generic USB CDC ethernet
          scripts/config --module CONFIG_USB_NET_CDC_NCM      # Modern CDC NCM
          scripts/config --module CONFIG_USB_NET_CDC_SUBSET   # CDC subset
          scripts/config --module CONFIG_USB_NET_CDC_EEM      # CDC EEM
          scripts/config --module CONFIG_USB_NET_AX8817X      # ASIX AX88xxx USB ethernet
          scripts/config --module CONFIG_USB_NET_AX88179_178A # ASIX AX88179/178A USB 3.0
          scripts/config --module CONFIG_USB_NET_RTL8150      # Realtek RTL8150
          scripts/config --module CONFIG_USB_NET_RTL8152      # Realtek RTL8152/RTL8153

          make olddefconfig

      - name: Build TQUIC module (compile check)
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          export PATH="/usr/lib/ccache:${PATH}"
          ccache -M 5G || true

          # Build prepare + scripts, then compile only TQUIC objects in-tree.
          # This catches all compilation errors (type mismatches, missing
          # includes, undeclared functions, etc.) without needing a full
          # kernel build. MODPOST is only meaningful with Module.symvers
          # from a full build, so it runs in the build-kernel job instead.
          make -j"$(nproc)" prepare scripts
          make -j"$(nproc)" net/quic/ net/tquic/

  # Full kernel package build — only for tags and manual workflow_dispatch
  build-kernel:
    name: "Build kernel ${{ inputs.kernel_full || '6.19' }}"
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write  # Required for creating GitHub releases

    steps:
      - name: Set build parameters
        id: params
        run: |
          # Use inputs if workflow_dispatch, otherwise use defaults for tag push
          KVER="${{ inputs.kernel_full || '6.19' }}"
          MAJOR="${{ inputs.kernel_major || '6' }}"
          TESTING="${{ inputs.kernel_testing || 'false' }}"
          ARTIFACT="${{ inputs.artifact_name || 'tquic-kernel-debs' }}"

          echo "kernel_full=${KVER}" >> $GITHUB_OUTPUT
          echo "kernel_major=${MAJOR}" >> $GITHUB_OUTPUT
          echo "kernel_testing=${TESTING}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT}" >> $GITHUB_OUTPUT
          echo "artifacts_dir=${HOME}/kernel-artifacts" >> $GITHUB_OUTPUT

          echo "Building kernel ${KVER} (major: ${MAJOR}, testing: ${TESTING})"

      - name: Checkout TQUIC source
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: >-
            ccache-${{ runner.os }}-${{ steps.params.outputs.kernel_full }}-${{
              hashFiles(
                '.github/workflows/kernel-package.yml',
                'net/quic/**',
                'net/tquic/**',
                'include/net/**',
                'include/uapi/**'
              )
            }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ steps.params.outputs.kernel_full }}-

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            bc bison build-essential cpio debhelper-compat \
            ccache \
            dwarves fakeroot flex kmod libdw-dev libelf-dev libssl-dev \
            pahole rsync xz-utils zstd

      - name: Download upstream kernel source
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-src && cd ~/kernel-src
          KVER="${{ steps.params.outputs.kernel_full }}"
          MAJOR="${{ steps.params.outputs.kernel_major }}"

          if [ "${{ steps.params.outputs.kernel_testing }}" = "true" ]; then
            URL="https://git.kernel.org/torvalds/t/linux-${KVER}.tar.gz"
            ARCHIVE="linux-${KVER}.tar.gz"
          else
            URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${KVER}.tar.xz"
            ARCHIVE="linux-${KVER}.tar.xz"
          fi

          echo "Downloading: ${URL}"
          curl -fSL \
            --connect-timeout 30 \
            --max-time 600 \
            --retry 5 \
            --retry-delay 10 \
            --retry-max-time 300 \
            -o "${ARCHIVE}" "${URL}"
          tar xf "${ARCHIVE}"
          rm -f "${ARCHIVE}"

      - name: Overlay TQUIC integration paths onto upstream kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          SRC="${GITHUB_WORKSPACE}"

          # Overlay only TQUIC-related paths so the result is a standard
          # upstream kernel plus TQUIC integration.
          for p in \
            "net/tquic/" \
            "net/quic/" \
            "net/Kconfig" \
            "net/Makefile" \
            "include/net/netns/tquic.h" \
            "include/net/net_namespace.h" \
            "include/net/tquic/" \
            "include/net/quic/" \
            "include/net/tquic.h" \
            "include/net/tquic_frame.h" \
            "include/net/tquic_http3.h" \
            "include/net/tquic_pm.h" \
            "include/net/tquic_pmtud.h" \
            "include/uapi/linux/tquic.h" \
            "include/uapi/linux/tquic_pm.h" \
            "include/uapi/linux/tquic_diag.h" \
            "include/uapi/linux/tquic_qlog.h"; do
            if [ -e "${SRC}/${p}" ]; then
              if [ -d "${SRC}/${p}" ]; then
                mkdir -p "${KDIR}/${p}"
                rsync -a --delete "${SRC}/${p}" "${KDIR}/${p}"
              else
                mkdir -p "$(dirname "${KDIR}/${p}")"
                install -m 0644 "${SRC}/${p}" "${KDIR}/${p}"
              fi
            fi
          done

      - name: Configure kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          make defconfig

          # Keep CI resilient across toolchain/kernel warning changes.
          # (Werror can be enabled indirectly via COMPILE_TEST.)
          scripts/config --disable CONFIG_WERROR

          # Build TQUIC as MODULE to avoid section mismatch warnings and
          # undefined reference errors with modular dependencies
          # CRITICAL: Enable CONFIG_IP_QUIC first - this is the main option
          # that gates all CONFIG_TQUIC_* sub-options in net/tquic/Kconfig
          scripts/config --enable CONFIG_MODULES
          scripts/config --module CONFIG_IP_QUIC

          # Enable TQUIC sub-features as modules
          scripts/config --module CONFIG_TQUIC_CORE
          scripts/config --module CONFIG_TQUIC_WAN_BONDING
          scripts/config --module CONFIG_TQUIC_MULTIPATH
          scripts/config --module CONFIG_TQUIC_PATH_MANAGER
          scripts/config --module CONFIG_TQUIC_PM_NETLINK
          scripts/config --module CONFIG_TQUIC_SCHEDULER
          scripts/config --module CONFIG_TQUIC_CONG
          scripts/config --module CONFIG_TQUIC_CRYPTO
          scripts/config --module CONFIG_TQUIC_CERT_VERIFY
          scripts/config --module CONFIG_TQUIC_IPV6

          # Enable dependencies as modules
          scripts/config --module CONFIG_INET_DIAG
          scripts/config --module CONFIG_CRYPTO_CURVE25519
          scripts/config --enable CONFIG_TRACEPOINTS

          # USB network drivers for phone tethering and USB ethernet adapters
          scripts/config --enable CONFIG_MII                  # MII library (required by USB_USBNET)
          scripts/config --module CONFIG_USB_USBNET           # USB networking framework (required base)
          scripts/config --enable CONFIG_USB_NET_DRIVERS
          scripts/config --module CONFIG_USB_IPHETH           # Apple iPhone USB tethering
          scripts/config --module CONFIG_USB_NET_RNDIS_HOST   # Android/Windows phone tethering
          scripts/config --module CONFIG_USB_NET_CDC_ETHER    # Generic USB CDC ethernet
          scripts/config --module CONFIG_USB_NET_CDC_NCM      # Modern CDC NCM
          scripts/config --module CONFIG_USB_NET_CDC_SUBSET   # CDC subset
          scripts/config --module CONFIG_USB_NET_CDC_EEM      # CDC EEM
          scripts/config --module CONFIG_USB_NET_AX8817X      # ASIX AX88xxx USB ethernet
          scripts/config --module CONFIG_USB_NET_AX88179_178A # ASIX AX88179/178A USB 3.0
          scripts/config --module CONFIG_USB_NET_RTL8150      # Realtek RTL8150
          scripts/config --module CONFIG_USB_NET_RTL8152      # Realtek RTL8152/RTL8153

          # Apply dependencies and finalize config
          make olddefconfig

      - name: Smoke build TQUIC (fast)
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          # Ensure generated headers + scripts exist, then compile only the
          # TQUIC-related parts. This catches real compiler errors quickly
          # without spending time on a full kernel build.
          make -j"$(nproc)" prepare scripts
          make -j"$(nproc)" net/quic/ net/tquic/

      - name: Build Debian kernel packages
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${{ steps.params.outputs.kernel_full }}
          cd "${KDIR}"

          export PATH="/usr/lib/ccache:${PATH}"
          ccache -M 5G || true

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-8)"
          LOCALVER="-tquic-${SHORT_SHA}"
          PKGVER="1.${GITHUB_RUN_NUMBER}"

          # Build image + headers + modules packages.
          make -j"$(nproc)" \
            LOCALVERSION="${LOCALVER}" \
            KDEB_PKGVERSION="${PKGVER}" \
            bindeb-pkg

      - name: Collect package artifacts
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-artifacts
          find ~/kernel-src -maxdepth 2 -type f \
            \( -name "*.deb" -o -name "*.changes" -o -name "*.buildinfo" \) \
            -exec cp -v {} ~/kernel-artifacts/ \;
          cd ~/kernel-artifacts
          sha256sum * > SHA256SUMS.txt
          ls -lah

      - name: Upload kernel packages
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.params.outputs.artifact_name }}-${{ steps.params.outputs.kernel_full }}
          path: ${{ steps.params.outputs.artifacts_dir }}/*
          if-no-files-found: error
          retention-days: 14

      - name: Determine release tag
        id: release_tag
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" = "true" ]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Auto-detected tag from push: ${{ github.ref_name }}"
          elif [ -n "${{ inputs.upload_to_release }}" ]; then
            echo "tag=${{ inputs.upload_to_release }}" >> $GITHUB_OUTPUT
            echo "Using manual tag: ${{ inputs.upload_to_release }}"
          else
            echo "tag=" >> $GITHUB_OUTPUT
            echo "No release tag specified, skipping upload"
          fi

      - name: Upload to GitHub Release
        if: steps.release_tag.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          files: ${{ steps.params.outputs.artifacts_dir }}/*
          prerelease: true
          fail_on_unmatched_files: false
          body: |
            ## TQUIC Kernel ${{ steps.params.outputs.kernel_full }}

            Kernel image and headers with TQUIC/multipath QUIC integrated.

            **Built from**: ${{ github.sha }}
            **Build date**: ${{ github.run_id }}

            ### Installation
            ```bash
            sudo dpkg -i linux-image-*.deb linux-headers-*.deb
            sudo reboot
            ```

            ### Verify
            ```bash
            uname -r  # Should show -tquic- in version
            modinfo tquic  # Check TQUIC module
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
