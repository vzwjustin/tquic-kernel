# SPDX-License-Identifier: GPL-2.0-only
#
# Automated kernel build for Claude development branches
# Validates section mismatches and builds kernel packages
#
name: Claude Branch Kernel Build

on:
  push:
    branches:
      - 'claude/**'
  pull_request:
    branches:
      - main

env:
  KERNEL_VERSION: "6.19-rc8"
  KERNEL_MAJOR: "6"

jobs:
  validate-build:
    name: "Build & Validate Kernel"
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout TQUIC source
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            bc bison build-essential cpio debhelper \
            ccache \
            dwarves fakeroot flex kmod libdw-dev libelf-dev libssl-dev \
            pahole rsync xz-utils zstd

      - name: Download upstream kernel source
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-src && cd ~/kernel-src
          URL="https://git.kernel.org/torvalds/t/linux-${KERNEL_VERSION}.tar.gz"
          echo "Downloading ${URL}"
          curl -fSL --retry 3 --retry-delay 5 -o "linux-${KERNEL_VERSION}.tar.gz" "${URL}"
          tar xf "linux-${KERNEL_VERSION}.tar.gz"
          rm -f "linux-${KERNEL_VERSION}.tar.gz"

      - name: Overlay TQUIC integration onto upstream kernel
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${KERNEL_VERSION}
          SRC="${GITHUB_WORKSPACE}"

          echo "Overlaying TQUIC files from ${SRC} to ${KDIR}"
          for p in \
            "net/tquic/" \
            "net/quic/" \
            "net/Kconfig" \
            "net/Makefile" \
            "include/net/netns/tquic.h" \
            "include/net/net_namespace.h" \
            "include/net/tquic/" \
            "include/net/quic/" \
            "include/net/tquic.h" \
            "include/net/tquic_frame.h" \
            "include/net/tquic_http3.h" \
            "include/net/tquic_pm.h" \
            "include/net/tquic_pmtud.h" \
            "include/uapi/linux/tquic.h" \
            "include/uapi/linux/tquic_pm.h" \
            "include/uapi/linux/tquic_diag.h" \
            "include/uapi/linux/tquic_qlog.h"; do
            if [ -e "${SRC}/${p}" ]; then
              if [ -d "${SRC}/${p}" ]; then
                mkdir -p "${KDIR}/${p}"
                rsync -a --delete "${SRC}/${p}" "${KDIR}/${p}"
              else
                mkdir -p "$(dirname "${KDIR}/${p}")"
                install -m 0644 "${SRC}/${p}" "${KDIR}/${p}"
              fi
              echo "  âœ“ ${p}"
            fi
          done

      - name: Configure kernel with TQUIC
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${KERNEL_VERSION}
          cd "${KDIR}"

          make defconfig

          # Disable Werror to avoid CI breakage from toolchain warnings
          scripts/config --disable CONFIG_WERROR

          # Enable TQUIC as MODULE (CONFIG_IP_QUIC is the master switch)
          # Building as module (=m) instead of built-in (=y) avoids section
          # mismatch warnings and allows modular dependencies
          scripts/config --enable CONFIG_MODULES
          scripts/config --module CONFIG_IP_QUIC
          scripts/config --module CONFIG_TQUIC_CORE
          scripts/config --module CONFIG_TQUIC_WAN_BONDING
          scripts/config --module CONFIG_TQUIC_MULTIPATH
          scripts/config --module CONFIG_TQUIC_PATH_MANAGER
          scripts/config --module CONFIG_TQUIC_PM_NETLINK
          scripts/config --module CONFIG_TQUIC_SCHEDULER
          scripts/config --module CONFIG_TQUIC_CONG
          scripts/config --module CONFIG_TQUIC_CRYPTO
          scripts/config --module CONFIG_TQUIC_CERT_VERIFY
          scripts/config --module CONFIG_TQUIC_IPV6

          # Enable dependencies (can be modules when TQUIC is module)
          scripts/config --module CONFIG_INET_DIAG
          scripts/config --module CONFIG_CRYPTO_CURVE25519
          scripts/config --enable CONFIG_TRACEPOINTS

          make olddefconfig

          echo "=== TQUIC Configuration ==="
          grep -E "CONFIG_IP_QUIC|CONFIG_TQUIC|CONFIG_INET_DIAG|CONFIG_CRYPTO_CURVE25519" .config || true

      - name: Build TQUIC modules (fast validation)
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${KERNEL_VERSION}
          cd "${KDIR}"

          export PATH="/usr/lib/ccache:${PATH}"
          ccache -M 5G || true

          echo "=== Preparing kernel build environment ==="
          make -j"$(nproc)" prepare scripts

          echo "=== Building TQUIC modules ==="
          make -j"$(nproc)" net/quic/ net/tquic/ 2>&1 | tee /tmp/tquic-build.log

          echo "=== Checking for warnings ==="
          if grep -i "section mismatch" /tmp/tquic-build.log; then
            echo "âŒ ERROR: Section mismatch warnings detected!"
            grep -A 5 "section mismatch" /tmp/tquic-build.log
            exit 1
          fi

          if grep -i "undefined reference" /tmp/tquic-build.log; then
            echo "âš ï¸  WARNING: Undefined references detected (may be config issue)"
            grep -A 2 "undefined reference" /tmp/tquic-build.log
          fi

          echo "âœ… TQUIC modules built successfully!"

      - name: Build full kernel with Debian packages
        run: |
          set -euo pipefail
          KDIR=~/kernel-src/linux-${KERNEL_VERSION}
          cd "${KDIR}"

          export PATH="/usr/lib/ccache:${PATH}"

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-8)"
          LOCALVER="-tquic-${SHORT_SHA}"
          PKGVER="1.${GITHUB_RUN_NUMBER}"

          echo "=== Building Debian kernel packages ==="
          make -j"$(nproc)" \
            LOCALVERSION="${LOCALVER}" \
            KDEB_PKGVERSION="${PKGVER}" \
            bindeb-pkg 2>&1 | tee /tmp/kernel-build.log

          echo "=== Final section mismatch check ==="
          if grep -i "section mismatch" /tmp/kernel-build.log; then
            echo "âŒ ERROR: Section mismatch warnings in final build!"
            grep -C 5 "section mismatch" /tmp/kernel-build.log
            exit 1
          fi

          echo "âœ… Kernel packages built successfully!"

      - name: Collect build artifacts
        run: |
          set -euo pipefail
          mkdir -p ~/kernel-artifacts
          find ~/kernel-src -maxdepth 2 -type f \
            \( -name "*.deb" -o -name "*.changes" -o -name "*.buildinfo" \) \
            -exec cp -v {} ~/kernel-artifacts/ \;

          cd ~/kernel-artifacts
          sha256sum *.deb > SHA256SUMS.txt 2>/dev/null || true
          ls -lah

      - name: Upload kernel packages
        uses: actions/upload-artifact@v4
        with:
          name: tquic-kernel-${{ env.KERNEL_VERSION }}-${{ github.sha }}
          path: ~/kernel-artifacts/*.deb
          if-no-files-found: error
          retention-days: 7

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Kernel**: \`${KERNEL_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/tquic-build.log ]; then
            if grep -q "section mismatch" /tmp/tquic-build.log; then
              echo "### âŒ Section Mismatch Detected" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep "section mismatch" /tmp/tquic-build.log | head -20 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… No Section Mismatches" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ -d ~/kernel-artifacts ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Packages Built" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh ~/kernel-artifacts/*.deb 2>/dev/null || echo "No packages found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
