# SPDX-License-Identifier: GPL-2.0-only
#
# CI workflow: Build TQUIC kernel module against multiple Linux kernel versions.
# Targets Linux 5.4+ LTS and stable releases to validate backward compatibility.
#
name: Kernel Module Build

on:
  push:
    paths:
      - 'net/quic/**'
      - 'net/tquic/**'
      - 'include/net/quic/**'
      - 'include/net/tquic/**'
      - 'include/net/tquic.h'
      - 'include/net/tquic_frame.h'
      - 'include/net/tquic_http3.h'
      - 'include/net/tquic_pm.h'
      - 'include/net/tquic_pmtud.h'
      - 'include/crypto/**'
      - 'include/uapi/**'
      - '.github/workflows/build.yml'
  pull_request:
    paths:
      - 'net/quic/**'
      - 'net/tquic/**'
      - 'include/net/quic/**'
      - 'include/net/tquic/**'
      - 'include/net/tquic.h'
      - 'include/net/tquic_frame.h'
      - 'include/net/tquic_http3.h'
      - 'include/net/tquic_pm.h'
      - 'include/net/tquic_pmtud.h'
      - '.github/workflows/build.yml'

jobs:
  build:
    name: "Build / Linux ${{ matrix.kernel }}"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - kernel: "6.1"
            kernel_full: "6.1.162"
            kernel_major: "6"
          - kernel: "6.6"
            kernel_full: "6.6.123"
            kernel_major: "6"
          - kernel: "6.12"
            kernel_full: "6.12.69"
            kernel_major: "6"
          - kernel: "6.18"
            kernel_full: "6.18.9"
            kernel_major: "6"
          - kernel: "6.19-rc8"
            kernel_full: "6.19-rc8"
            kernel_major: "6"
            kernel_testing: true

    steps:
      - name: Checkout TQUIC source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            build-essential bc kmod cpio flex bison \
            libssl-dev libelf-dev dwarves pahole

      - name: Cache kernel source
        uses: actions/cache@v4
        id: kernel-cache
        with:
          path: ~/kernel-src/linux-${{ matrix.kernel_full }}
          key: kernel-${{ matrix.kernel_full }}-prepared-v5

      - name: Download kernel source
        if: steps.kernel-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/kernel-src && cd ~/kernel-src
          MAJOR="${{ matrix.kernel_major }}"
          KVER="${{ matrix.kernel_full }}"

          # kernel.org URL pattern: v5.x or v6.x subdirectory
          # RC kernels are in the testing/ subdirectory
          if [ "${{ matrix.kernel_testing }}" = "true" ]; then
            URL="https://git.kernel.org/torvalds/t/linux-${KVER}.tar.gz"
          else
            URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${KVER}.tar.xz"
          fi
          echo "Downloading ${URL} ..."
          ARCHIVE="linux-${KVER}.tar.${URL##*.}"
          curl -fSL --retry 3 --retry-delay 5 -o "${ARCHIVE}" "${URL}"
          tar xf "${ARCHIVE}"
          rm -f "${ARCHIVE}"

      - name: Prepare kernel headers
        if: steps.kernel-cache.outputs.cache-hit != 'true'
        run: |
          cd ~/kernel-src/linux-${{ matrix.kernel_full }}
          # Use allnoconfig as base (minimal) then enable what TQUIC needs
          make allnoconfig
          # Avoid warnings-as-errors failures due to toolchain variance.
          scripts/config --disable CONFIG_WERROR
          # Core networking
          scripts/config --enable CONFIG_NET
          scripts/config --enable CONFIG_INET
          scripts/config --enable CONFIG_IPV6
          scripts/config --enable CONFIG_MODULES
          # Crypto subsystem (required by TQUIC)
          scripts/config --enable CONFIG_CRYPTO
          scripts/config --enable CONFIG_CRYPTO_AEAD
          scripts/config --enable CONFIG_CRYPTO_AEAD2
          scripts/config --enable CONFIG_CRYPTO_AES
          scripts/config --enable CONFIG_CRYPTO_GCM
          scripts/config --enable CONFIG_CRYPTO_CHACHA20POLY1305
          scripts/config --enable CONFIG_CRYPTO_SHA256
          scripts/config --enable CONFIG_CRYPTO_SHA512
          scripts/config --enable CONFIG_CRYPTO_HASH
          scripts/config --enable CONFIG_CRYPTO_HASH2
          scripts/config --enable CONFIG_CRYPTO_SKCIPHER
          scripts/config --enable CONFIG_CRYPTO_SKCIPHER2
          scripts/config --enable CONFIG_CRYPTO_AKCIPHER
          scripts/config --enable CONFIG_CRYPTO_AKCIPHER2
          # Key subsystem (required by cert_verify for asymmetric key types)
          scripts/config --enable CONFIG_KEYS
          scripts/config --enable CONFIG_ASYMMETRIC_KEY_TYPE
          scripts/config --enable CONFIG_ASYMMETRIC_PUBLIC_KEY_SUBTYPE
          # UDP tunnel (TQUIC dependency)
          scripts/config --enable CONFIG_NET_UDP_TUNNEL
          # Networking features used by TQUIC
          scripts/config --enable CONFIG_XFRM
          scripts/config --enable CONFIG_INET_TUNNEL
          scripts/config --enable CONFIG_PROC_FS
          scripts/config --enable CONFIG_PROC_SYSCTL
          scripts/config --enable CONFIG_SYSCTL
          scripts/config --enable CONFIG_NETDEVICES
          scripts/config --enable CONFIG_NETFILTER
          # Inet diagnostics (inet_diag_register)
          scripts/config --enable CONFIG_INET_DIAG
          # Generic netlink (genl_register_family)
          scripts/config --enable CONFIG_NET_NS
          # Tracing support
          scripts/config --enable CONFIG_TRACEPOINTS
          # modpost: treat section mismatches as warnings (out-of-tree consolidated
          # modules have __init/__exit cross-references that are harmless)
          scripts/config --enable CONFIG_SECTION_MISMATCH_WARN_ONLY
          # Resolve any dependency conflicts
          make olddefconfig
          # Prepare headers and build scripts (no full kernel compile)
          make modules_prepare

      - name: Build TQUIC module (out-of-tree)
        run: |
          KDIR=~/kernel-src/linux-${{ matrix.kernel_full }}
          TQUIC_SRC="${GITHUB_WORKSPACE}/net/tquic"
          echo "Building TQUIC against kernel ${{ matrix.kernel_full }} ..."
          echo "  KDIR=${KDIR}"
          echo "  TQUIC_SRC=${TQUIC_SRC}"

          # Build the out-of-tree module using the Kbuild file.
          # The Kbuild itself sets up include paths via ccflags-y.
          # KBUILD_MODPOST_WARN=1: modules_prepare does not produce a full
          # Module.symvers, so modpost cannot resolve in-kernel symbols
          # (crypto_*, netlink_*, etc.).  These symbols ARE available at
          # runtime; the flag downgrades modpost errors to warnings so the
          # CI build succeeds.
          make -j"$(nproc)" -C "${KDIR}" M="${TQUIC_SRC}" KBUILD_MODPOST_WARN=1 modules 2>&1 | tee build.log
          EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "=== Build artifacts ==="
          find "${TQUIC_SRC}" -name '*.ko' -exec ls -lh {} \; || true

          if [ "${EXIT_CODE}" -ne 0 ]; then
            echo ""
            echo "=== Last 50 lines of build output ==="
            tail -50 build.log
            exit "${EXIT_CODE}"
          fi

      - name: Check for build warnings
        if: success()
        run: |
          WARNS=$(grep -c ' warning:' build.log || true)
          echo "Build completed with ${WARNS} warning(s)."
          if [ "${WARNS}" -gt 0 ]; then
            echo "::warning::Build produced ${WARNS} compiler warning(s)"
            grep ' warning:' build.log | sort -u | head -30
          fi

      - name: Verify module info
        if: success()
        run: |
          TQUIC_SRC="${GITHUB_WORKSPACE}/net/tquic"
          KO=$(find "${TQUIC_SRC}" -name 'tquic.ko' -print -quit)
          if [ -z "${KO}" ]; then
            echo "::error::tquic.ko not found - build may have failed"
            exit 1
          fi
          echo "=== modinfo ==="
          modinfo "${KO}" || true
